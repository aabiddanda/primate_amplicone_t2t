#!python3

import numpy as np
import pandas as pd


configfile: "config.yaml"


rule all:
    input:
        expand(
            "results/{species}/ref.chrY.mappability.bed",
            species=list(config.keys())[1],
        ),


rule download_fasta_fastaidx:
    """Download fasta file from remote repositories. """
    output:
        fasta="results/{species}/ref.fasta.gz",
        faidx="results/{species}/ref.fasta.gzi",
    params:
        fasta=lambda wildcards: config[wildcards.species]["fasta"],
        faidx=lambda wildcards: config[wildcards.species]["faidx"],
    resources:
        time="0:30:00",
        mem_mb="5G",
    shell:
        """
        wget {params.fasta} -O {output.fasta}
        wget {params.faidx} -O {output.faidx} 
        """


rule ref_specific_mappability:
    """Generate reference-specific mappability metrics for AmpliCONE."""
    input:
        ref_fasta="results/{species}/ref.fasta.gz",
    output:
        ref_fasta="results/{species}/ref.chrY.fa",
        gem_index="results/{species}/ref.chrY.fa.gem",
        mappability="results/{species}/ref.chrY.mappability",
        mappability_bg=temp("results/{species}/ref.chrY.mappability.bg"),
        mappability_bed="results/{species}/ref.chrY.mappability.bed",
    resources:
        time="3:00:00",
        mem_mb="10G",
    params:
        out_wig=lambda wildcards: f"results/{wildcards.species}/ref.chrY",
        read_size=lambda wildcards: config[wildcards.species]["readsize"],
    threads: 24
    shell:
        """
       samtools faidx {input.ref_fasta} chrY > {output.ref_fasta}
       gem-indexer -i {output.ref_fasta} -o {output.ref_fasta} --complement emulate -T {threads} --verbose
       gem-mappability -I {output.gem_index} -l {params.read_size} -o {params.out_wig} -m 2 -e 2 -T {threads}
       gem-2-bed mappability -I {output.gem_index} -i {output.mappability} -o {params.out_wig}
       cp {output.mappability_bg} {output.mappability_bed}
       """


rule ref_specific_repeatmasker:
    """Obtain reference-specific repeatmasker output."""
    input:
        ref_fasta=lambda wildcards: config[wildcards.species]["fasta"],
    output:
        repeatmasker="results/{species}/ref.repeatmasker.out",
    shell:
        "RepeatMasker {input.ref_fasta}"


# rule ref_specific_tandemrepeat:
# """Obtain reference-specific tandem repeat output."""
# input:
# ref_fasta = lambda wildcards: config[wildcards.species]["fasta"]
# output:
# tandem_repeat_dat = "results/{species}/ref.repeatmasker.dat"
# shell:
# "trf"
# rule tandemrepeat2bed:
# """Convert tandem-repeat output to bed-output as well."""
# pass
